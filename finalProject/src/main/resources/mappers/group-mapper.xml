<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="groupMapper">

	<!-- resultMap   -->
	<resultMap id="groupTableResultSet" type="GroupTable">
		<id property="gNo" column="G_NO"/>
		<result property="gTitle" column="G_TITLE"/>
		<result property="gCon" column="G_CON"/>
		<result property="gName" column="G_NAME"/>
		<result property="gOrigin" column="G_ORIGIN"/>
		<result property="gRename" column="G_RENAME"/>
		<result property="gDelete" column="G_DELETE"/>
		<result property="id" column="ID"/>
		
		<result property="gmNo" column="GM_NO"/>
		<result property="gmId" column="GM_ID"/>
		<result property="gmDelete" column="GM_DELETE"/>
	</resultMap>
	
	<resultMap id="groupMemberResultSet" type="GroupMember">
		<id property="gmNO" column="GM_NO"/>
		<result property="gmId" column="GM_ID"/>
		<result property="gNo" column="G_NO"/>
		<result property="gmDelete" column="GM_DELETE"/>
	</resultMap>
	

	<resultMap id="memberResultSet" type="Member">
		<id property="id" column="ID"/>
		<result property="name" column="NAME"/>
	</resultMap>

	<resultMap id="groupNoticeResultSet" type="GroupNotice">
		<id property="gnNo" column="GN_NO"/>
		<result property="gmNo" column="GM_NO"/>
		<result property="gNo" column="G_NO"/>
		<result property="gnTitle" column="GN_TITLE"/>
		<result property="gnCon" column="GN_CON"/>
		<result property="gnDate" column="GN_DATE"/>
		<result property="gnDelete" column="GN_DELETE"/>
		<result property="gnCount" column="GN_COUNT"/>
		<result property="name" column="NAME"/>
	</resultMap>
	
	<resultMap id="groupBoardResultSet" type="GroupBoard">
		<id property="gbNo" column="GB_NO"/>
		<result property="gmNo" column="GM_NO"/>
		<result property="gNo" column="G_NO"/>
		<result property="gbTitle" column="GB_TITLE"/>
		<result property="gbCon" column="GB_CON"/>
		<result property="gbDate" column="GB_DATE"/>
		<result property="gbDelete" column="GB_DELETE"/>
		<result property="gbCount" column="GB_COUNT"/>
		<result property="name" column="NAME"/>
	</resultMap>
	<!-- resultMap end -->
	
	<!-- 그룹 메인 및 생성 -->	
	<select id="selectGroup" resultMap="groupTableResultSet">
		SELECT GT.G_NO AS G_NO, G_TITLE, G_CON, G_NAME, G_ORIGIN, G_DELETE, ID, G_DATE, GM_NO, GM_ID, GM_DELETE
		FROM GROUP_TABLE GT
		JOIN GROUP_MEMBER GM ON(GT.G_NO = GM.G_NO)
		WHERE GM_ID = #{loginUserId}
	</select>

	<select id="selectGroupMember" resultMap="groupMemberResultSet">
		SELECT GM_NO, GM_ID, G_NO, GM_DELETE, NAME
		FROM GROUP_MEMBER TM
		JOIN MEMBER M ON(TM.GM_ID  = M.ID)
	</select> 

	<select id="searchNameList" parameterType="GroupSearchName" resultMap="memberResultSet">
		SELECT ID, NAME
		FROM MEMBER
		WHERE NAME LIKE '%' || #{searchName} || '%' 
		 AND ID NOT IN  #{loginUserId}
	</select>
	
	<insert id="groupInsert" parameterType="GroupTable">
		INSERT INTO GROUP_TABLE VALUES(
		SEQ_GID.NEXTVAL,
		#{gTitle},
		#{gCon},
		#{gName},
		#{gOrigin},
		#{gOrigin},
		#{gDelete},
		#{id},
		SYSDATE
		)
	</insert>
	
	<insert id="insertOrderList" parameterType="java.util.List">
		INSERT INTO JUMUN(ORDER_NO, MENU, AMOUNT, ORDER_DATE, TABLE_NO, PAY_YN)
		SELECT SEQ_JUMUN.NEXTVAL , J.*
		FROM (
		<foreach collection="list" item="item" index="ix" separator="UNION ALL">
			SELECT #{item.MENU} AS MENU , #{item.AMOUNT} AS AMOUNT , SYSDATE AS ORDER_DATE , #{item.TABLE_NO} AS TABLE_NO, 'N'
			FROM DUAL 
		</foreach>
		)J
	</insert>
	
	<select id="groupNoSelect" resultType="_int">
		SELECT SEQ_GID.CURRVAL
		FROM DUAL
	</select>
	
	
	
	<insert id="groupMemberInsert" parameterType="arraylist">
		INSERT INTO GROUP_MEMBER(GM_NO, GM_ID, G_NO, GM_DELETE)
		SELECT SEQ_GM.NEXTVAL , M.*
		FROM (
		<foreach collection="list" item="memberList" index="ix" separator="UNION ALL">
			SELECT #{memberList.groupMemberId} AS GM_ID, #{memberList.groupNo} AS G_NO , 'N' 
			FROM DUAL 
		</foreach>
		)M
	</insert>
	
	<!-- 그룹 메인 및 생성 end -->
	
	<!-- 그룹 캘린더 -->
	<select id="memberNoSelect" parameterType="GroupInfo" resultType="_int">
		SELECT GM_NO
		FROM GROUP_MEMBER
		WHERE G_NO = #{groupNo} 
		AND GM_ID = #{loginUserId}
	</select>
	<!-- 그룹 캘린더 end-->
	
	<!-- 그룹 공지 -->
	<select id="selectNoticeList" parameterType="GroupInfo" resultMap="groupNoticeResultSet">
		SELECT GN_NO, GN.GM_NO AS GM_NO, GN.G_NO AS G_NO, GN_TITLE, GN_CON, GN_DATE, GN_DELETE, GN_COUNT, NAME
		FROM GROUP_NOTICE GN
		JOIN GROUP_MEMBER GM ON(GN.GM_NO = GM.GM_NO)
        JOIN MEMBER M ON (GM.GM_ID = M.ID)
        WHERE GN.G_NO = #{groupNo}
<!--         AND GN.GM_NO = #{gmNo} -->
		ORDER BY GN_NO DESC
	</select>
	
	<select id="getListCount" resultType="_int">
		SELECT COUNT(*)
		FROM GROUP_NOTICE
		WHERE GN_DELETE = 'N'
		AND G_NO = #{groupNo}
	</select>
	
	<insert id="noticeInsert" parameterType="GroupNotice">
		INSERT INTO GROUP_NOTICE 
		VALUES(SEQ_GN.NEXTVAL,
				#{gmNo},
				#{gNo},
				#{gnTitle},
				#{gnCon},
				SYSDATE,
				'N',
				0)
	</insert>
	
	<update id="noticeUpdate" parameterType="GroupNotice">
		UPDATE GROUP_NOTICE SET GN_TITLE = #{gnTitle}, GN_CON = #{gnCon}
		WHERE GN_NO = #{gnNo}
	</update>
	<!-- 그룹 공지  end -->
	
	<!-- 그룹 게시판 -->
	<select id="selectNoticeOne" resultMap="groupNoticeResultSet">
		SELECT *
		FROM (
			SELECT GN_NO, GN.GM_NO AS GM_NO, GN.G_NO AS G_NO, GN_TITLE, GN_CON, GN_DATE, GN_DELETE, GN_COUNT, NAME
			FROM GROUP_NOTICE GN
			JOIN GROUP_MEMBER GM ON(GN.GM_NO = GM.GM_NO)
	        JOIN MEMBER M ON (GM.GM_ID = M.ID)
	        WHERE GN.G_NO = #{groupNo}
	        ORDER BY GN_NO DESC
		)
		WHERE ROWNUM =1
	</select>

	<select id="boardGetListCount" resultType="_int">
		SELECT COUNT(*)
		FROM GROUP_BOARD
		WHERE GB_DELETE = 'N'
	</select>
	
	<select id="selectBoardList" parameterType="GroupInfo" resultMap="groupBoardResultSet">
		SELECT GB_NO, GB.GM_NO AS GM_NO, GB.G_NO AS G_NO, GB_TITLE, GB_CON, GB_DATE, GB_DELETE, GB_COUNT, NAME
		FROM GROUP_BOARD GB
		JOIN GROUP_MEMBER GM ON(GB.GM_NO = GM.GM_NO)
        JOIN MEMBER M ON (GM.GM_ID = M.ID)
        WHERE GB.G_NO = #{groupNo}
		ORDER BY GB_NO DESC
	</select>
	
</mapper>
