<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="planMapper">

	<resultMap type="Menstrual" id="mcResultSet">
		<id property="id" column="ID"/>
		<result property="mcFirst" column="MC_FIRST"/>
		<result property="mcCycle" column="MC_CYCLE"/>
		<result property="mcPeriod" column="MC_PERIOD"/>
		<result property="mcLast" column="MC_LAST"/>
		
		<result property="mcDelete" column="MC_DELETE"/>
	</resultMap>

	<resultMap type="McRecord" id="mcrResultSet">
		<id property="mcrNo" column="MCR_NO"/>
		<result property="id" column="ID"/>
		<result property="mcrStart" column="MCR_START"/>
		<result property="mcrEnd" column="MCR_END"/>
		<result property="mcrDelete" column="MCR_DELETE"/>
	</resultMap>
	
	<resultMap type="McOvulation" id="mcoResultSet">
		<id property="mcoNo" column="MCO_NO"/>
		<result property="id" column="ID"/>
		<result property="mcoStart" column="MCO_START"/>
		<result property="mcoEnd" column="MCO_END"/>
		<result property="mcoDelete" column="MCO_DELETE"/>
	</resultMap>
	
	<select id="checkInfo" parameterType="string" resultType="_int">
		SELECT COUNT(*)
		FROM MENSTRUAL_CALENDAR
		WHERE ID=#{id}
			AND MC_DELETE='N'
	</select>
	
	<select id="selectMenstrual" parameterType="string" resultMap="mcResultSet">
		SELECT ID, TO_CHAR(MC_FIRST, 'YYYY-MM-DD') "MC_FIRST", MC_CYCLE
		    , MC_PERIOD, TO_CHAR(MC_LAST, 'YYYY-MM-DD') "MC_LAST", MC_DELETE
		FROM MENSTRUAL_CALENDAR
		WHERE ID=#{id}
		    AND MC_DELETE='N'
	</select>
	
	<insert id="insertMenstrual" parameterType="Menstrual">
		INSERT INTO MENSTRUAL_CALENDAR VALUES(
			#{id}
			, TO_DATE(#{mcFirst},'YYYY-MM-DD')
			, DEFAULT
			, DEFAULT
			, TO_DATE(#{mcFirst},'YYYY-MM-DD')+28
			, DEFAULT
			, DEFAULT
		)
	</insert>
	
	<insert id="insertMcRecord" parameterType="Menstrual">
		INSERT INTO M_CALENDAR_RECORD VALUES(
			SEQ_MCR.NEXTVAL
			, #{id}
			, TO_DATE(#{mcLast},'YYYY-MM-DD')
			, TO_DATE(#{mcLast},'YYYY-MM-DD')+#{mcPeriod}
			, DEFAULT
		)
	</insert>
	
	<insert id="insertMcOvulation" parameterType="Menstrual">
		INSERT INTO M_CALENDAR_OVULATION VALUES(
			SEQ_MCO.NEXTVAL
			, #{id}
			, TO_DATE(#{mcLast},'YYYY-MM-DD')-19
			, TO_DATE(#{mcLast},'YYYY-MM-DD')-12
			, DEFAULT
		)
	</insert>
	
	<update id="updateMcLast" parameterType="Menstrual">
		UPDATE MENSTRUAL_CALENDAR
		SET MC_LAST=MC_LAST+MC_CYCLE
		WHERE ID=#{id}
	</update>
	
	<select id="selectMcrList" parameterType="string" resultMap="mcrResultSet">
		SELECT MCR_NO, ID, TO_CHAR(MCR_START, 'YYYY-MM-DD') "MCR_START", TO_CHAR(MCR_END, 'YYYY-MM-DD') "MCR_END", MCR_DELETE
		FROM M_CALENDAR_RECORD
		WHERE ID=#{id}
			AND MCR_DELETE='N'
	</select>
	
	<select id="selectMcoList" parameterType="string" resultMap="mcoResultSet">
		SELECT MCO_NO, ID, TO_CHAR(MCO_START, 'YYYY-MM-DD') "MCO_START", TO_CHAR(MCO_END, 'YYYY-MM-DD') "MCO_END", MCO_DELETE
		FROM M_CALENDAR_OVULATION
		WHERE ID=#{id}
			AND MCO_DELETE='N'
	</select>
	
	<update id="updateMenstrual" parameterType="Menstrual">
		UPDATE MENSTRUAL_CALENDAR
		SET MC_CYCLE=#{mcCycle}
			, MC_PERIOD=#{mcPeriod}
			, MC_UPDATE=SYSDATE
		WHERE ID=#{id}
	</update>
	
	<select id="afterMcrList" parameterType="Menstrual" resultMap="mcrResultSet">
		SELECT MCR_NO, ID, TO_CHAR(MCR_START, 'YYYY-MM-DD') "MCR_START", TO_CHAR(MCR_END, 'YYYY-MM-DD') "MCR_END", MCR_DELETE
		FROM M_CALENDAR_RECORD
		WHERE ID=#{id}
            AND MCR_START >= SYSDATE
			AND MCR_DELETE='N'
	</select>
	
	<select id="afterMcoList" parameterType="Menstrual" resultMap="mcoResultSet">
		SELECT MCO_NO, ID, TO_CHAR(MCO_START, 'YYYY-MM-DD') "MCO_START", TO_CHAR(MCO_END, 'YYYY-MM-DD') "MCO_END", MCO_DELETE
		FROM M_CALENDAR_OVULATION
		WHERE ID=#{id}
            AND MCO_START >= SYSDATE
			AND MCO_DELETE='N'
	</select>
	
	<delete id="deleteMcRecord" parameterType="McRecord">
		DELETE
		FROM M_CALENDAR_RECORD
		WHERE MCR_NO=#{mcrNo}
	</delete>
	
	<delete id="deleteMcOvulation" parameterType="McOvulation">
		DELETE
		FROM M_CALENDAR_OVULATION
		WHERE MCO_NO=#{mcoNo}
	</delete>
	
	<update id="reMcLast" parameterType="Menstrual">
		UPDATE MENSTRUAL_CALENDAR
		SET MC_LAST=(SELECT MCR_START
		            FROM(SELECT *
		                FROM M_CALENDAR_RECORD
		                WHERE ID=#{id}
		                ORDER BY MCR_START DESC)
		            WHERE ROWNUM = 1) + MC_CYCLE
		WHERE ID=#{id}
	</update>
	
	<select id="selectMcLast" parameterType="Menstrual" resultType="string">
		SELECT TO_CHAR(MC_LAST, 'YYYY-MM-DD') "MC_LAST"
		FROM MENSTRUAL_CALENDAR
		WHERE ID=#{id}
			AND MC_DELETE='N'
	</select>
	
	<update id="firstMcLast" parameterType="Menstrual">
		UPDATE MENSTRUAL_CALENDAR
		SET MC_LAST=MC_FIRST+MC_CYCLE
		WHERE ID=#{id}
	</update>
	
	<select id="checkMcLast" parameterType="Menstrual" resultType="_int">
		SELECT COUNT(*)
		FROM M_CALENDAR_RECORD
		WHERE ID=#{id}
		    AND EXTRACT(MONTH FROM MCR_START)>EXTRACT(MONTH FROM SYSDATE)
		    AND MCR_DELETE='N'
	</select>
	
</mapper>
